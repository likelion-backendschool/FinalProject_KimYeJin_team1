package com.yejin.exam.wbook.domain.withdraw.controller;

import com.yejin.exam.wbook.domain.member.entity.Member;
import com.yejin.exam.wbook.domain.withdraw.dto.WithdrawApplyDto;
import com.yejin.exam.wbook.domain.withdraw.entity.WithdrawApply;
import com.yejin.exam.wbook.domain.withdraw.service.WithdrawService;
import com.yejin.exam.wbook.global.base.dto.MemberContext;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.stereotype.Controller;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.ModelAndView;

import javax.validation.Valid;
import java.util.List;
@Api(tags = "출금 API")
@RestController
@RequestMapping("/api/v1/withdraw")
@RequiredArgsConstructor
@Slf4j
public class WithdrawController {

    private final WithdrawService withdrawService;

    @GetMapping("/apply")
    public ModelAndView showApply(@AuthenticationPrincipal MemberContext memberContext, ModelAndView mav, WithdrawApplyDto withdrawApplydto){
        log.debug("[withdraw] get apply form");
        Member member = memberContext.getMember();
        log.debug("[withdraw] name : "+member.getUsername() + " cash : "+member.getRestCash());
        mav.addObject("actorRestCash",member.getRestCash());
        mav.setViewName("withdraw/apply");
        return mav;
    }
    @ApiOperation(value = "주문품목 단건 정산")
    @ApiResponses({
            @ApiResponse(code = 200, message = "S001 - 주문품목번호 %d번에 대해서 판매자에게 %s원 정산을 완료하였습니다."),
            @ApiResponse(code = 400, message = "FOO1 - 정산가능한 주문 품목이 없습니다.\n"
                    + "F002 - 정산을 할 수 없는 상태입니다."),
            @ApiResponse(code = 401, message = "M003 - 로그인이 필요한 화면입니다."),
            @ApiResponse(code = 403, message = "M004 - 관리자 권한이 필요한 화면입니다."),
    })
    @PostMapping("/apply")
    public ModelAndView apply(@AuthenticationPrincipal MemberContext memberContext, @Valid WithdrawApplyDto withdrawApplydto, ModelAndView mav, BindingResult bindingResult){
        log.debug("[withdraw] post apply form");

        mav.setViewName("withdraw/apply");

        if (bindingResult.hasErrors()) {
            return mav;
        }
        Member member = memberContext.getMember();
        WithdrawApply withdrawApply = withdrawService.apply(member, withdrawApplydto);

        final boolean isApplied = withdrawApply.isApplied();
        if (isApplied) {
            mav.addObject("msg", "출금 신청이 완료되었습니다.");
            mav.addObject("url", "/withdraw/applyList");
            mav.setViewName("common/alert");
            return mav;
        } else {
            mav.addObject("msg", "출금 신청에 실패하였습니다.");
            mav.addObject("url", "/withdraw/apply");
            mav.setViewName("common/alert");
            return mav;
        }
    }

    @GetMapping("/applyList")
    public ModelAndView applyList(@AuthenticationPrincipal MemberContext memberContext, ModelAndView mav){
        Member member = memberContext.getMember();
        List<WithdrawApply> withdrawApplies = withdrawService.findByMember(member);
        mav.addObject("withdrawApplies", withdrawApplies);
        mav.setViewName("withdraw/applyList");
        return mav;

    }
}
